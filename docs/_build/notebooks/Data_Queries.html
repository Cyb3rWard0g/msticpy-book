---
redirect_from:
  - "/notebooks/data-queries"
interact_link: content/notebooks/Data_Queries.ipynb
kernel_name: python3
kernel_path: content/notebooks
has_widgets: false
title: |-
  Title: msticpy - Data
pagenum: 8
prev_page:
  url: /notebooks/Base64Unpack.html
next_page:
  url: /notebooks/EventClustering.html
suffix: .ipynb
search: query queries data code parameters provider defined default description environment codequeryprovider name files file new driver store parameter return id set str definition our dataenvironment string msticpy package connecting running list dataframe yaml available pre connect source pass also custom results run required arguments metadata instantiating directory providers once connection returns passed execute type defining sources log analytics azure contents ad hoc creating adding example options calling optional import simply union self iterable datafamily queryname does exception any imported found defaults not into automatically c provides well elements sentinel security microsoft using reviewing reviewqueries runquery runadhoc addnew order need define

comment: "***PROGRAMMATICALLY GENERATED, DO NOT EDIT. SEE ORIGINAL FILES IN /content***"
---

    <main class="jupyter-page">
    <div id="page-info"><div id="page-title">Title: msticpy - Data</div>
</div>
    <div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Description:">Description:<a class="anchor-link" href="#Description:"> </a></h2><p>This package provides functions to allow for the defining of data sources, connectors to them, and queries for them as well as the ability to call these elements to return query result from the defined data sources.
The package currently support connections to Log Analytics/Azure Sentinel/Azure Security Center, and the Microsoft Security Graph.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first step in using this package is to install the msticpy package.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install msticpy --upgrade --user
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Collecting git+https://github.com/microsoft/msticpy
Building wheels for collected packages: msticpy
  Building wheel for msticpy (setup.py): started
  Building wheel for msticpy (setup.py): finished with status &#39;done&#39;
Successfully built msticpy
Installing collected packages: msticpy
Successfully installed msticpy-0.2.1
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='contents'></a></p>
<h2 id="Table-of-Contents">Table of Contents<a class="anchor-link" href="#Table-of-Contents"> </a></h2><ul>
<li><a href="#instantiating">Instantiating a Query Provider</a></li>
<li><a href="#connecting">Connecting to a Data Environment</a></li>
<li><a href="#review_queries">Reviewing available queries</a></li>
<li><a href="#run_query">Running a pre-defined query</a></li>
<li><a href="#run_adhoc">Running an ad-hoc query</a></li>
<li><a href="#new">Creating a new set of queries</a></li>
<li><a href="#add_new">Adding a new set of queries and running them</a></li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Check we are running Python 3.6</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">MIN_REQ_PYTHON</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="n">MIN_REQ_PYTHON</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Check the Kernel-&gt;Change Kernel menu and ensure that Python 3.6&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;or later is selected as the active kernel.&#39;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Python </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> or later is required.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">MIN_REQ_PYTHON</span><span class="p">)</span>

<span class="c1">#imports</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">msticpy.nbtools</span> <span class="k">as</span> <span class="nn">nbtools</span>

<span class="c1">#data library imports</span>
<span class="kn">from</span> <span class="nn">msticpy.data.data_providers</span> <span class="kn">import</span> <span class="n">QueryProvider</span>
<span class="kn">import</span> <span class="nn">msticpy.data.data_query_reader</span> <span class="k">as</span> <span class="nn">QueryReader</span>
<span class="kn">from</span> <span class="nn">msticpy.data.param_extractor</span> <span class="kn">import</span> <span class="n">extract_query_params</span>
<span class="kn">import</span> <span class="nn">msticpy.nbtools</span> <span class="k">as</span> <span class="nn">mas</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imports Complete&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Imports Complete
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='instantiating'></a></p>
<h3 id="Instantiating-a-Query-Provider">Instantiating a Query Provider<a class="anchor-link" href="#Instantiating-a-Query-Provider"> </a></h3><p>In order to connect to and query a data source we need to define what sort of Data Environment we want to connect to and query (in this Notebook we will use Log Analytics as an example). To view the options available you can call <code>QueryProvider.list_data_environments()</code> which will return a list of all the available options.</p>
<p>After selecting a Data Environment we can initialize our Query Provider by calling <code>QueryProvider(DATA_ENVIRONMENT)</code>. This will load the relavent driver for connecting to the data environment we have selected as well as provisioning a query store for us and adding queries from our default query directory.</p>
<p>There are two other optional parameters we can pass when initializing our Query Providers to further customize it:</p>
<ul>
<li>We can also chose to initialize our Query Provider with a driver other than the defualt one with <code>QueryProvider(data_environment=DATA_ENVIRONMENT, driver=QUERY_DRIVER)</code></li>
<li>We can choose to import queries from a custom query directory (see - <a href="#new">Creating a new set of queries</a> for more details) with <code>QueryProvider(data_environment=DATA_ENVIRONMENT, driver=QUERY_DRIVER, query_path=QUERY_DIRECTORY_PATH)</code>. </li>
</ul>
<p>For now we will simply create a Query Provider with default values.</p>

<pre><code>Query provider interface to queries.

    Parameters
    ----------
    data_environment : Union[str, DataEnvironment]
        Name or Enum of environment for the QueryProvider
    driver : DriverBase, optional
        Override the built-in driver (query execution class)
        and use your own driver (must inherit from
        `DriverBase`)</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data_environments</span> <span class="o">=</span> <span class="n">QueryProvider</span><span class="o">.</span><span class="n">list_data_environments</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_environments</span><span class="p">)</span>
<span class="n">qry_prov</span> <span class="o">=</span> <span class="n">QueryProvider</span><span class="p">(</span><span class="n">data_environment</span><span class="o">=</span><span class="s1">&#39;LogAnalytics&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[&#39;LogAnalytics&#39;, &#39;Kusto&#39;, &#39;AzureSecurityCenter&#39;, &#39;SecurityGraph&#39;]
Please wait. Loading Kqlmagic extension...
</pre>
</div>
</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<html>
            <head>
            <style>
            .kql-magic-banner {
                display: flex; 
                background-color: #d9edf7;
            }
            .kql-magic-banner > div {
                margin: 10px; 
                padding: 20px; 
                color: #3a87ad; 
                font-size: 13px;
            }
            </style>
            </head>
            <body>
                <div class='kql-magic-banner'>
                    <div><img src='data:image/png;base64,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'></div>
                    <div>
                        <p>Kql Query Language, aka kql, is the query language for advanced analytics on Azure Monitor resources. The current supported data sources are 
                        Azure Data Explorer (Kusto), Log Analytics and Application Insights. To get more information execute '%kql --help "kql"'</p>
                        <p>   &bull; kql reference: Click on 'Help' tab > and Select 'kql reference' or execute '%kql --help "kql"'<br>
                          &bull; Kqlmagic configuration: execute '%config Kqlmagic'<br>
                          &bull; Kqlmagic usage: execute '%kql --usage'<br>
                    </div>
                </div>
            </body>
            </html>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<html>
        <head>

        </head>
        <body>
        <div><p style='padding: 10px; color: #3a87ad; background-color: #d9edf7; border-color: #bce9f1'>Kqlmagic&nbsppackage&nbspis&nbspupdated&nbspfrequently.&nbspRun&nbsp&apos;!pip&nbspinstall&nbspKqlmagic&nbsp--no-cache-dir&nbsp--upgrade&apos;&nbspto&nbspuse&nbspthe&nbsplatest&nbspversion.<br>Kqlmagic&nbspversion:&nbsp0.1.100,&nbspsource:&nbsphttps://github.com/Microsoft/jupyter-Kqlmagic</p></div>
        </body>
        </html>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="f16ef2ad-5d54-411f-8154-3297e085d31b"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#f16ef2ad-5d54-411f-8154-3297e085d31b');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="0623a121-903e-40b4-af62-d26d50d3bb96"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#0623a121-903e-40b4-af62-d26d50d3bb96');
try {IPython.notebook.kernel.reconnect();} catch(err) {;}
</script>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='connecting'></a></p>
<h3 id="Connecting-to-a-Data-Environment">Connecting to a Data Environment<a class="anchor-link" href="#Connecting-to-a-Data-Environment"> </a></h3><p>Once we have instantiated the query provider and loaded the relevent driver we can connect to the Data Environment. This is done by calling the <code>connect()</code> function of the Query Provider we just initialized and passing it a connection string to use.</p>
<p>For Log Analytics/Azure Sentinel the connection string is in the format of <code>loganalytics://code().tenant("TENANT_ID").workspace("WORKSPACE_ID")</code>. Other Data Environments will have different connection string formats.</p>

<pre><code>connect(self, connection_str: str, **kwargs):

    Connect to data source.

    Parameters
    ----------
    connection_string : str
        Connection string for the data source</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ws_id</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Workspace ID&#39;</span><span class="p">)</span>
<span class="n">ten_id</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Tenant ID&#39;</span><span class="p">)</span>
<span class="n">la_connection_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;loganalytics://code().tenant(&quot;</span><span class="si">{ten_id}</span><span class="s1">&quot;).workspace(&quot;</span><span class="si">{ws_id}</span><span class="s1">&quot;)&#39;</span>
<span class="n">qry_prov</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connection_str</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{la_connection_string}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">


</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="5683a61e-12a3-4f69-a6e1-3b5d2501dc7b"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#5683a61e-12a3-4f69-a6e1-3b5d2501dc7b');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<!DOCTYPE html>
                <html><body>

                <!-- h1 id="user_code_p"><b>BTYMGY4BP</b><br></h1-->

                <input  id="kql_MagicCodeAuthInput" type="text" readonly style="font-weight: bold; border: none;" size = '9' value='BTYMGY4BP'>

                <button id='kql_MagicCodeAuth_button', onclick="this.style.visibility='hidden';kql_MagicCodeAuthFunction()">Copy code to clipboard and authenticate</button>

                <script>
                var kql_MagicUserCodeAuthWindow = null
                function kql_MagicCodeAuthFunction() {
                    /* Get the text field */
                    var copyText = document.getElementById("kql_MagicCodeAuthInput");

                    /* Select the text field */
                    copyText.select();

                    /* Copy the text inside the text field */
                    document.execCommand("copy");

                    /* Alert the copied text */
                    // alert("Copied the text: " + copyText.value);

                    var w = screen.width / 2;
                    var h = screen.height / 2;
                    params = 'width='+w+',height='+h
                    kql_MagicUserCodeAuthWindow = window.open('https://microsoft.com/devicelogin', 'kql_MagicUserCodeAuthWindow', params);

                    // TODO: save selected cell index, so that the clear will be done on the lince cell
                }
                </script>

                </body></html>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<!DOCTYPE html>
                    <html><body><script>

                        // close authentication window
                        if (kql_MagicUserCodeAuthWindow && kql_MagicUserCodeAuthWindow.opener != null && !kql_MagicUserCodeAuthWindow.closed) {
                            kql_MagicUserCodeAuthWindow.close()
                        }
                        // TODO: make sure, you clear the right cell. BTW, not sure it is a must to do any clearing

                        // clear output cell
                        Jupyter.notebook.clear_output(Jupyter.notebook.get_selected_index())

                        // TODO: if in run all mode, move to last cell, otherwise move to next cell
                        // move to next cell

                    </script></body></html>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<!DOCTYPE html>
            <html><body>

            <button onclick="this.style.visibility='visible';kql_MagicLaunchWindowFunction('Kqlmagic_temp_files/_b1315f05-4a7a-45b4-811f-73e715f7c122_at_loganalytics_schema.html','fullscreen=no,directories=no,location=no,menubar=no,resizable=yes,scrollbars=yes,status=no,titlebar=no,toolbar=no,','_b1315f05_4a7a_45b4_811f_73e715f7c122_at_loganalytics_schema','')">popup schema b1315f05-4a7a-45b4-811f-73e715f7c122@loganalytics</button>

            <script>

            function kql_MagicLaunchWindowFunction(file_path, window_params, window_name, notebooks_host) {
                var url;
                if (file_path.startsWith('http')) {
                    url = file_path;
                } else {
                    var base_url = '';

                    // check if azure notebook
                    var azure_host = (notebooks_host == null || notebooks_host.length == 0) ? 'https://notebooks.azure.com' : notebooks_host;
                    var start = azure_host.search('//');
                    var azure_host_suffix = '.' + azure_host.substring(start+2);

                    var loc = String(window.location);
                    var end = loc.search(azure_host_suffix);
                    start = loc.search('//');
                    if (start > 0 && end > 0) {
                        var parts = loc.substring(start+2, end).split('-');
                        if (parts.length == 2) {
                            var library = parts[0];
                            var user = parts[1];
                            base_url = azure_host + '/api/user/' +user+ '/library/' +library+ '/html/';
                        }
                    }

                    // check if local jupyter lab
                    if (base_url.length == 0) {
                        var configDataScipt  = document.getElementById('jupyter-config-data');
                        if (configDataScipt != null) {
                            var jupyterConfigData = JSON.parse(configDataScipt.textContent);
                            if (jupyterConfigData['appName'] == 'JupyterLab' && jupyterConfigData['serverRoot'] != null &&  jupyterConfigData['treeUrl'] != null) {
                                var basePath = 'C:/' + '/';
                                if (basePath.startsWith(jupyterConfigData['serverRoot'])) {
                                    base_url = '/files/' + basePath.substring(jupyterConfigData['serverRoot'].length+1);
                                }
                            } 
                        }
                    }

                    // assume local jupyter notebook
                    if (base_url.length == 0) {

                        var parts = loc.split('/');
                        parts.pop();
                        base_url = parts.join('/') + '/';
                    }
                    url = base_url + file_path;
                }

                window.focus();
                var w = screen.width / 2;
                var h = screen.height / 2;
                params = 'width='+w+',height='+h;
                kql_Magic__b1315f05_4a7a_45b4_811f_73e715f7c122_at_loganalytics_schema = window.open(url, window_name, window_params + params);
            }
            </script>

            </body></html>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='review_queries'></a></p>
<h3 id="Reviewing-available-queries">Reviewing available queries<a class="anchor-link" href="#Reviewing-available-queries"> </a></h3><p>Upon connecting to the relevant Data Environment we need to look at what query options we have available to us. In order to do this we can call <code>QUERY_PROVIDER.list_queries().</code> This will return a generator with the names of all the queries in our store.</p>
<p>The results returned show the data family the query belongs to and the name of the specific query.</p>

<pre><code>list_queries(self):

    Return list of family.query in the store.

    Returns
    -------
    Iterable[str]
        List of queries</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">qry_prov</span><span class="o">.</span><span class="n">list_queries</span><span class="p">()</span>
<span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>LinuxSyslog.all_syslog
LinuxSyslog.cron_activity
LinuxSyslog.squid_activity
LinuxSyslog.sudo_activity
LinuxSyslog.user_group_activity
LinuxSyslog.user_logon
SecurityAlert.get_alert
SecurityAlert.list_alerts
SecurityAlert.list_alerts_counts
SecurityAlert.list_alerts_for_ip
SecurityAlert.list_related_alerts
WindowsSecurity.get_host_logon
WindowsSecurity.get_parent_process
WindowsSecurity.get_process_tree
WindowsSecurity.list_host_logon_failures
WindowsSecurity.list_host_logons
WindowsSecurity.list_host_processes
WindowsSecurity.list_hosts_matching_commandline
WindowsSecurity.list_matching_processes
WindowsSecurity.list_processes_in_session
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To get further details on a specific query call <code>QUERY_PROVIDER.DATA_FAMILY.QUERY_NAME('?')</code> or <code>QUERY_PROVIDER.DATA_FAMILY.QUERY_NAME('help')</code></p>
<p>This will display:</p>
<ul>
<li>Query Name</li>
<li>What Data Environment it is designed for</li>
<li>Short description of what the query does</li>
<li>What parameter the query can be passed</li>
<li>The raw query that will be run</li>
</ul>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">SecurityAlert</span><span class="o">.</span><span class="n">list_alerts</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Query:  list_alerts
Data source:  LogAnalytics
Retrieves list of alerts

Parameters
----------
add_query_items: str (optional)
    Additional query clauses
end: datetime
    Query end time
path_separator: str (optional)
    Path separator
    (default value is: \\)
query_project: str (optional)
    Column project statement
    (default value is:  | project-rename StartTimeUtc = StartTime, EndTim...)
start: datetime
    Query start time
subscription_filter: str (optional)
    Optional subscription/tenant filter expression
    (default value is: true)
table: str (optional)
    Table name
    (default value is: SecurityAlert)
Query:
 {table} {query_project} | where {subscription_filter} | where TimeGenerated &gt;= datetime({start}) | where TimeGenerated &lt;= datetime({end}) | extend extendedProps = parse_json(ExtendedProperties) | extend CompromisedEntity = tostring(extendedProps[&#34;Compromised Host&#34;]) | project-away extendedProps {add_query_items}
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='run_query'></a></p>
<h3 id="Running-an-pre-defined-query">Running an pre-defined query<a class="anchor-link" href="#Running-an-pre-defined-query"> </a></h3><p>To run a query from our query store we again call <code>QUERY_PROVIDER.DATA_FAMILY.QUERY_NAME(**Kwargs)</code> but this time we simply pass required parameters for that query as key word arguments.</p>
<p>This will return a Pandas DataFrame of the results with the columns determined by the query parameters. Should the query fail for some reason an exception will be raised.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">alerts</span> <span class="o">=</span> <span class="n">qry_prov</span><span class="o">.</span><span class="n">SecurityAlert</span><span class="o">.</span><span class="n">list_alerts</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2019-07-21 23:43:18.274492&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2019-07-27 23:43:18.274492&#39;</span><span class="p">)</span>
<span class="n">alerts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="85edba81-569b-4c33-97e9-80122d81c7f0"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#85edba81-569b-4c33-97e9-80122d81c7f0');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="6fa21bbf-cbf6-47a8-b41e-142c2b801317"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#6fa21bbf-cbf6-47a8-b41e-142c2b801317');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TenantId</th>
      <th>TimeGenerated</th>
      <th>AlertDisplayName</th>
      <th>AlertName</th>
      <th>Severity</th>
      <th>Description</th>
      <th>ProviderName</th>
      <th>VendorName</th>
      <th>VendorOriginalId</th>
      <th>SystemAlertId</th>
      <th>...</th>
      <th>ExtendedProperties</th>
      <th>Entities</th>
      <th>SourceSystem</th>
      <th>WorkspaceSubscriptionId</th>
      <th>WorkspaceResourceGroup</th>
      <th>ExtendedLinks</th>
      <th>ProductName</th>
      <th>ProductComponentName</th>
      <th>Type</th>
      <th>CompromisedEntity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>2518385291989119899_8af9954d-f28d-40ff-a079-d9...</td>
      <td>...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>5d60fff6-7dd2-4474-a4d0-4c8e3fa6fad6</td>
      <td>...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 07:02:42</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>ba07c315-0af5-4568-9ecd-6c788f9267ae</td>
      <td>b7adb73b-0778-4929-b46a-c0ed642bc61f</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "3389",\r\n  "Proto...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-26 06:03:16</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>c3144593-9bae-448e-87dd-b2d3c47de571</td>
      <td>d89ad3b2-f7a7-4cff-b8a4-3f6fa58b4760</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "22",\r\n  "Protoco...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-23 06:42:01</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>4e4173a6-1a27-451f-8a3c-25d10b306c30</td>
      <td>11813ab7-ab7c-4719-b0a1-ccb5d4a32223</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "3389",\r\n  "Proto...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
  </tbody>
</table>
<p>5 rows × 30 columns</p>
</div>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It is also possible to pass queries objects as arguments before defining keywork arguments. 
For example if I wanted to define query times as an object rather than defining a start and end via keywork arguments I could simply pass a querytimes object to the pre-defined query.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">query_times</span> <span class="o">=</span> <span class="n">mas</span><span class="o">.</span><span class="n">nbwidgets</span><span class="o">.</span><span class="n">QueryTime</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span>  
                            <span class="n">max_before</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">max_after</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">query_times</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">




 
 
<div id="789445e4-6900-4138-83ab-55d61889f278"></div>
<div class="output_subarea output_widget_view ">
<script type="text/javascript">
var element = $('#789445e4-6900-4138-83ab-55d61889f278');
</script>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5e8588414e5a4b36823f460350aa735d", "version_major": 2, "version_minor": 0}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




 
 
<div id="e7b57697-b8a9-43dd-80eb-02cc21ff1d94"></div>
<div class="output_subarea output_widget_view ">
<script type="text/javascript">
var element = $('#e7b57697-b8a9-43dd-80eb-02cc21ff1d94');
</script>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d1302e236120441d92d03cffd28a0ca4", "version_major": 2, "version_minor": 0}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




 
 
<div id="13dcd6d0-b04c-4e63-92cb-2d3a1b7d1e2e"></div>
<div class="output_subarea output_widget_view ">
<script type="text/javascript">
var element = $('#13dcd6d0-b04c-4e63-92cb-2d3a1b7d1e2e');
</script>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c0f9a5a7d4a3483f87e86baca8d7d399", "version_major": 2, "version_minor": 0}
</script>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">SecurityAlert</span><span class="o">.</span><span class="n">list_alerts</span><span class="p">(</span><span class="n">query_times</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="fbf33127-6e29-4cdf-97ca-1bfa3aeee0e2"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#fbf33127-6e29-4cdf-97ca-1bfa3aeee0e2');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="91031617-9499-479c-b684-26af3fad92d8"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#91031617-9499-479c-b684-26af3fad92d8');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TenantId</th>
      <th>TimeGenerated</th>
      <th>AlertDisplayName</th>
      <th>AlertName</th>
      <th>Severity</th>
      <th>Description</th>
      <th>ProviderName</th>
      <th>VendorName</th>
      <th>VendorOriginalId</th>
      <th>SystemAlertId</th>
      <th>...</th>
      <th>ExtendedProperties</th>
      <th>Entities</th>
      <th>SourceSystem</th>
      <th>WorkspaceSubscriptionId</th>
      <th>WorkspaceResourceGroup</th>
      <th>ExtendedLinks</th>
      <th>ProductName</th>
      <th>ProductComponentName</th>
      <th>Type</th>
      <th>CompromisedEntity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-26 06:03:16</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>c3144593-9bae-448e-87dd-b2d3c47de571</td>
      <td>d89ad3b2-f7a7-4cff-b8a4-3f6fa58b4760</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "22",\r\n  "Protoco...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>1</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-23 06:42:01</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>4e4173a6-1a27-451f-8a3c-25d10b306c30</td>
      <td>11813ab7-ab7c-4719-b0a1-ccb5d4a32223</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "3389",\r\n  "Proto...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>2</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>2518385291989119899_8af9954d-f28d-40ff-a079-d9...</td>
      <td>...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>3</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>5d60fff6-7dd2-4474-a4d0-4c8e3fa6fad6</td>
      <td>...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
    <tr>
      <th>4</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 07:02:42</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>ba07c315-0af5-4568-9ecd-6c788f9267ae</td>
      <td>b7adb73b-0778-4929-b46a-c0ed642bc61f</td>
      <td>...</td>
      <td>{\r\n  "Destination Port": "3389",\r\n  "Proto...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
      <td></td>
    </tr>
  </tbody>
</table>
<p>5 rows × 30 columns</p>
</div>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='run_adhoc'></a></p>
<h3 id="Running-an-ad-hoc-query">Running an ad-hoc query<a class="anchor-link" href="#Running-an-ad-hoc-query"> </a></h3><p>It is also possible to run ad-hoc queries via a similar method. Rather than calling a named query from the Query Provider query store, we can pass a query directly to our Query Provider with <code>QUERY_PROVIDER.exec_query(query=QUERY_STRING)</code>. This will execute the query string passed in the parameters with the driver contained in the Query Provider and return data in a Pandas DataFrame. As with predefined queries an exception will be raised should the query fail to execute.</p>

<pre><code>query(self, query: str) -&gt; Union[pd.DataFrame, Any]:
    Execute query string and return DataFrame of results.

    Parameters
    ----------
    query : str
        The kql query to execute

    Returns
    -------
    Union[pd.DataFrame, results.ResultSet]
        A DataFrame (if successful) or
        Kql ResultSet if an error.</code></pre>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    SecurityAlert</span>
<span class="s1">    | take 5</span>
<span class="s1">    &#39;&#39;&#39;</span>

<span class="n">query_test</span> <span class="o">=</span> <span class="n">qry_prov</span><span class="o">.</span><span class="n">exec_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">test_query</span><span class="p">)</span>
<span class="n">query_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="49f06674-9054-4d5a-ab6b-98a140091f24"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#49f06674-9054-4d5a-ab6b-98a140091f24');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="edc043c8-41d1-4c6f-be39-0768bf287729"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#edc043c8-41d1-4c6f-be39-0768bf287729');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TenantId</th>
      <th>TimeGenerated</th>
      <th>DisplayName</th>
      <th>AlertName</th>
      <th>AlertSeverity</th>
      <th>Description</th>
      <th>ProviderName</th>
      <th>VendorName</th>
      <th>VendorOriginalId</th>
      <th>SystemAlertId</th>
      <th>...</th>
      <th>RemediationSteps</th>
      <th>ExtendedProperties</th>
      <th>Entities</th>
      <th>SourceSystem</th>
      <th>WorkspaceSubscriptionId</th>
      <th>WorkspaceResourceGroup</th>
      <th>ExtendedLinks</th>
      <th>ProductName</th>
      <th>ProductComponentName</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>2518385291989119899_8af9954d-f28d-40ff-a079-d9...</td>
      <td>...</td>
      <td>[\r\n  "1. Enforce the use of strong passwords...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 06:35:13</td>
      <td>Suspicious authentication activity</td>
      <td>Suspicious authentication activity</td>
      <td>Medium</td>
      <td>Although none of them succeeded, some of them ...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>8af9954d-f28d-40ff-a079-d9d4cc5a5268</td>
      <td>5d60fff6-7dd2-4474-a4d0-4c8e3fa6fad6</td>
      <td>...</td>
      <td>[\r\n  "1. Enforce the use of strong passwords...</td>
      <td>{\r\n  "Activity start time (UTC)": "2019/07/2...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "HostName":...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td>[\r\n  {\r\n    "Href": "https://interflowwebp...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-22 07:02:42</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>ba07c315-0af5-4568-9ecd-6c788f9267ae</td>
      <td>b7adb73b-0778-4929-b46a-c0ed642bc61f</td>
      <td>...</td>
      <td>[\r\n  "1. Review the IP addresses and determi...</td>
      <td>{\r\n  "Destination Port": "3389",\r\n  "Proto...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-07-26 06:03:16</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Traffic from unrecommended IP addresses was de...</td>
      <td>Low</td>
      <td>Azure security center has detected incoming tr...</td>
      <td>AdaptiveNetworkHardenings</td>
      <td>Microsoft</td>
      <td>c3144593-9bae-448e-87dd-b2d3c47de571</td>
      <td>d89ad3b2-f7a7-4cff-b8a4-3f6fa58b4760</td>
      <td>...</td>
      <td>[\r\n  "1. Review the IP addresses and determi...</td>
      <td>{\r\n  "Destination Port": "22",\r\n  "Protoco...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "ResourceId...</td>
      <td>Detection</td>
      <td></td>
      <td></td>
      <td>[\r\n  {\r\n    "DetailBladeInputs": "protecte...</td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>2019-06-27 00:31:35</td>
      <td>Security incident with shared process detected</td>
      <td>Security incident with shared process detected</td>
      <td>High</td>
      <td>The incident which started on 2019-06-25 21:24...</td>
      <td>Detection</td>
      <td>Microsoft</td>
      <td>be88b671-2572-4373-af4a-323849b1da1d</td>
      <td>2518408029550429999_be88b671-2572-4373-af4a-32...</td>
      <td>...</td>
      <td>[\r\n  "1. Escalate the alert to the informati...</td>
      <td>{\r\n  "isincident": "true",\r\n  "Detected Ti...</td>
      <td>[\r\n  {\r\n    "$id": "4",\r\n    "DisplayNam...</td>
      <td>Detection</td>
      <td>3b701f84-d04b-4479-89b1-fa8827eb537e</td>
      <td>sentineltest</td>
      <td></td>
      <td>Azure Security Center</td>
      <td></td>
      <td>SecurityAlert</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 29 columns</p>
</div>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='new'></a></p>
<h3 id="Creating-a-new-set-of-queries">Creating a new set of queries<a class="anchor-link" href="#Creating-a-new-set-of-queries"> </a></h3><p>msticpy provides a number of pre-defined queries to call with using the data package. You can also add in additional queries to be imported and used by your Query Provider, these are defined in YAML format files and examples of these files can be found at the msticpy GitHub site <a href="https://github.com/microsoft/msticpy/tree/master/msticpy/data/queries">https://github.com/microsoft/msticpy/tree/master/msticpy/data/queries</a>.</p>
<p>The required structure of these query definition files is as follows:</p>
<ul>
<li>metadata<ul>
<li>version: The version number of the definition file</li>
<li>description: A description of the purpose of this collection of query definitions</li>
<li>data_environments[]: A list of the Data Environments that the defined queries can be run against (1 or more)</li>
<li>data_families[]: A list of Data Families the defined queries related to, these families are defined as part of misticpy.nbtools.query_defns</li>
<li>tags[]: A list of tags to help manage definition files</li>
</ul>
</li>
<li>defaults: A set of defaults that apply to all queries in the file<ul>
<li>metadata: Metadata regarding a query<ul>
<li>data_source: The data source to be used for the query</li>
</ul>
</li>
<li>parameters: Parameters to be passed to the query<ul>
<li>name: The parameter name</li>
<li>description: A description of what the parameter is</li>
<li>type: The data type of the parameter</li>
<li>default: The default value for that parameter</li>
</ul>
</li>
</ul>
</li>
<li>sources: a set of queries<ul>
<li>name: The name of the query
  -description: A description of the query's function
  -metadata: Any metadata associated with the query
  -args: The arguments of the query
<pre><code>  -query: The query to be executed
  -uri: A URI associated with the query
</code></pre>
  -parameters: Any parameters required by the query not covered by defaults
<pre><code>  - name: The parameter name
  - description: A description of what the parameter is
  - type: The data type of the parameter
  - default: The default value for that parameter</code></pre>
</li>
</ul>
</li>
</ul>
<p>There are also a number of tools within the package to assist in validating new query definition files once created.</p>

<pre><code>data_query_reader.find_yaml_files

    Return iterable of yaml files found in `source_path`.

    Parameters
    ----------
    source_path : str
        The source path to search in.
    recursive : bool, optional
        Whether to recurse through subfolders.
        By default False

    Returns
    -------
    Iterable[str]
        File paths of yaml files found.

 data_query_reader.validate_query_defs

     Validate content of query definition.

    Parameters
    ----------
    query_def_dict : dict
        Dictionary of query definition yaml file contents.

    Returns
    -------
    bool
        True if validation succeeds.

    Raises
    ------
    ValueError
        The validation failure reason is returned in the
        exception message (arg[0])

</code></pre>
<p><code>validate_query_defs()</code> does not perform comprehensive checks on the file but does check key elements required in the file are present.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">QueryReader</span><span class="o">.</span><span class="n">find_yaml_files</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="s2">&quot;C:</span><span class="se">\\</span><span class="s2">queries&quot;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_handle</span><span class="p">:</span>
        <span class="n">yaml_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f_handle</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">QueryReader</span><span class="o">.</span><span class="n">validate_query_defs</span><span class="p">(</span><span class="n">query_def_dict</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{file}</span><span class="s1"> is a valid query definition&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There is an error with </span><span class="si">{file}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> C:\queries\example.yaml is a valid query definition
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a id='add_new'></a></p>
<h3 id="Adding-a-new-set-of-queries-and-running-them">Adding a new set of queries and running them<a class="anchor-link" href="#Adding-a-new-set-of-queries-and-running-them"> </a></h3><p>Once you are happy with a query definition file then you import it with <code>QUERY_PROVIDER.import_query_file(query_file=PATH_TO_QUERY_FILE)</code>
This will load the query file into the Query Provider's Query Store from where it can be called.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">import_query_file</span><span class="p">(</span><span class="n">query_file</span><span class="o">=</span><span class="s1">&#39;C:\queries\example.yaml&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once imported the queries in the files appear in the Query Provider's Query Store alongside the others and can be called in the same manner as pre-defined queries.</p>
<p>If you have created a large number of query definition files and you want to have the automatically imported into a Query Provider's query store at initialization you can specify a directory containing these queries in the msticpyconfig.yaml file under QueryDefinitions: Custom:</p>
<p>For example if I have a folder at C:\queries I will set the config file to:</p>
<p>QueryDefinitions:
  Default: "queries"
  Custom:</p>

<pre><code>- "C:\\queries"
- "C:\\queries2 


</code></pre>
<p>Having the Custom field populated will mean the Query Provider will automatically enumerate all the YAML files in the directory provided and automatically import he relevant queries into the query store at initialization alongside the default queries. Custom queries with the same name as default queries will overwrite default queries.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">qry_prov</span><span class="o">.</span><span class="n">list_queries</span><span class="p">()</span>
<span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>LinuxSyslog.all_syslog
LinuxSyslog.cron_activity
LinuxSyslog.squid_activity
LinuxSyslog.sudo_activity
LinuxSyslog.syslog_example
LinuxSyslog.user_group_activity
LinuxSyslog.user_logon
SecurityAlert.get_alert
SecurityAlert.list_alerts
SecurityAlert.list_alerts_counts
SecurityAlert.list_alerts_for_ip
SecurityAlert.list_related_alerts
WindowsSecurity.get_host_logon
WindowsSecurity.get_parent_process
WindowsSecurity.get_process_tree
WindowsSecurity.list_host_logon_failures
WindowsSecurity.list_host_logons
WindowsSecurity.list_host_processes
WindowsSecurity.list_hosts_matching_commandline
WindowsSecurity.list_matching_processes
WindowsSecurity.list_processes_in_session
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">LinuxSyslog</span><span class="o">.</span><span class="n">syslog_example</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Query:  syslog_example
Data source:  LogAnalytics
Example query

Parameters
----------
add_query_items: str (optional)
    Additional query clauses
end: datetime
    Query end time
host_name: str
    Hostname to query for
query_project: str (optional)
    Column project statement
    (default value is:  | project TenantId, Computer, Facility, TimeGener...)
start: datetime
    Query start time
subscription_filter: str (optional)
    Optional subscription/tenant filter expression
    (default value is: true)
table: str (optional)
    Table name
    (default value is: Syslog)
Query:
 {table} | where {subscription_filter} | where TimeGenerated &gt;= datetime({start}) | where TimeGenerated &lt;= datetime({end}) | where Computer == &#34;{host_name}&#34; | take 5
</pre>
</div>
</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">LinuxSyslog</span><span class="o">.</span><span class="n">syslog_example</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2019-07-21 23:43:18.274492&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2019-07-27 23:43:18.274492&#39;</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="s1">&#39;UbuntuDevEnv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="99fefb25-3210-4d4f-82b3-1cd89bfd175f"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#99fefb25-3210-4d4f-82b3-1cd89bfd175f');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">




<div id="79cdace8-e538-4f6d-8de0-00ff213fb927"></div>
<div class="output_subarea output_javascript ">
<script type="text/javascript">
var element = $('#79cdace8-e538-4f6d-8de0-00ff213fb927');
try {IPython.notebook.kernel.execute("NOTEBOOK_URL = '" + window.location + "'");} catch(err) {;}
</script>
</div>

</div>
</div>
<div class="jb_output_wrapper }}">
<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TenantId</th>
      <th>SourceSystem</th>
      <th>TimeGenerated</th>
      <th>Computer</th>
      <th>EventTime</th>
      <th>Facility</th>
      <th>HostName</th>
      <th>SeverityLevel</th>
      <th>SyslogMessage</th>
      <th>ProcessID</th>
      <th>HostIP</th>
      <th>ProcessName</th>
      <th>MG</th>
      <th>Type</th>
      <th>_ResourceId</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>Linux</td>
      <td>2019-07-25 15:15:37.213</td>
      <td>UbuntuDevEnv</td>
      <td>2019-07-25 15:15:37</td>
      <td>authpriv</td>
      <td>UbuntuDevEnv</td>
      <td>notice</td>
      <td>omsagent : TTY=unknown   PWD=/opt/microsoft/om...</td>
      <td>NaN</td>
      <td>10.0.1.4</td>
      <td>sudo</td>
      <td>00000000-0000-0000-0000-000000000002</td>
      <td>Syslog</td>
      <td>/subscriptions/3b701f84-d04b-4479-89b1-fa8827e...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>Linux</td>
      <td>2019-07-25 15:15:37.313</td>
      <td>UbuntuDevEnv</td>
      <td>2019-07-25 15:15:37</td>
      <td>authpriv</td>
      <td>UbuntuDevEnv</td>
      <td>info</td>
      <td>pam_unix(sudo:session): session opened for use...</td>
      <td>NaN</td>
      <td>10.0.1.4</td>
      <td>sudo</td>
      <td>00000000-0000-0000-0000-000000000002</td>
      <td>Syslog</td>
      <td>/subscriptions/3b701f84-d04b-4479-89b1-fa8827e...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>Linux</td>
      <td>2019-07-25 15:15:37.917</td>
      <td>UbuntuDevEnv</td>
      <td>2019-07-25 15:15:37</td>
      <td>authpriv</td>
      <td>UbuntuDevEnv</td>
      <td>info</td>
      <td>pam_unix(sudo:session): session closed for use...</td>
      <td>NaN</td>
      <td>10.0.1.4</td>
      <td>sudo</td>
      <td>00000000-0000-0000-0000-000000000002</td>
      <td>Syslog</td>
      <td>/subscriptions/3b701f84-d04b-4479-89b1-fa8827e...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>Linux</td>
      <td>2019-07-25 15:15:50.793</td>
      <td>UbuntuDevEnv</td>
      <td>2019-07-25 15:15:50</td>
      <td>authpriv</td>
      <td>UbuntuDevEnv</td>
      <td>info</td>
      <td>pam_unix(cron:session): session closed for use...</td>
      <td>29486.0</td>
      <td>10.0.1.4</td>
      <td>CRON</td>
      <td>00000000-0000-0000-0000-000000000002</td>
      <td>Syslog</td>
      <td>/subscriptions/3b701f84-d04b-4479-89b1-fa8827e...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b1315f05-4a7a-45b4-811f-73e715f7c122</td>
      <td>Linux</td>
      <td>2019-07-25 15:16:01.800</td>
      <td>UbuntuDevEnv</td>
      <td>2019-07-25 15:16:01</td>
      <td>authpriv</td>
      <td>UbuntuDevEnv</td>
      <td>info</td>
      <td>pam_unix(cron:session): session opened for use...</td>
      <td>29844.0</td>
      <td>10.0.1.4</td>
      <td>CRON</td>
      <td>00000000-0000-0000-0000-000000000002</td>
      <td>Syslog</td>
      <td>/subscriptions/3b701f84-d04b-4479-89b1-fa8827e...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you are having difficulties with a defined query and it is not producing the expected results it can be useful to see the raw query exactly as it is passed to the Data Environment. If you call a query with 'print' and the parameters required by that query it will construct and print out the query string to be run.</p>

</div>
</div>
</div>
</div>

<div class="jb_cell">

<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">qry_prov</span><span class="o">.</span><span class="n">LinuxSyslog</span><span class="o">.</span><span class="n">syslog_example</span><span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2019-07-21 23:43:18.274492&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2019-07-27 23:43:18.274492&#39;</span><span class="p">,</span> <span class="n">host_name</span><span class="o">=</span><span class="s1">&#39;UbuntuDevEnv&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="jb_output_wrapper }}">
<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39; Syslog | where true | where TimeGenerated &gt;= datetime(2019-07-21 23:43:18.274492) | where TimeGenerated &lt;= datetime(2019-07-27 23:43:18.274492) | where Computer == &#34;UbuntuDevEnv&#34; | take 5&#39;</pre>
</div>

</div>
</div>
</div>
</div>

</div>
</div>

 


    </main>
    